// ============================================================================
// WICHTIG: Manuelle Migrationen!
// ============================================================================
// Dieses Projekt verwendet Supabase mit pgBouncer (Connection Pooling).
// Daher werden Migrationen NICHT automatisch mit `prisma migrate dev` erstellt,
// sondern manuell:
//
// 1. Schema hier anpassen
// 2. Migration SQL-Datei manuell erstellen unter:
//    prisma/migrations/YYYYMMDDHHMMSS_beschreibung/migration.sql
// 3. Migration deployen mit: npx prisma migrate deploy
// 4. Prisma Client neu generieren: npx prisma generate
//
// Siehe auch: https://www.prisma.io/docs/guides/deployment/deploy-database-changes-with-prisma-migrate
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "extensions")]
}

model User {
  id                      String                  @id @default(cuid())
  email                   String?                 @unique
  name                    String?
  password                String
  role                    Role                    @default(CUSTOMER)
  clientId                String?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  active                  Boolean                 @default(true)
  color                   String?
  categories              AgentCategory[]
  fullName                String?
  roleTitle               String?
  favoriteClients         FavoriteClient[]
  feedbacks               Feedback[]              @relation("FeedbackAuthor")
  noticesCreated          Notice[]                @relation("NoticesCreated")
  customerNoticesCreated  CustomerNotice[]        @relation("CustomerNoticesCreated")
  noticeAcknowledgements  NoticeAcknowledgement[]
  noticeAssignments       NoticeRecipient[]
  projects                Project[]               @relation("AgentProjects")
  filmProjectsCutting     ProjectFilm[]           @relation("FilmProjectCutter")
  filmProjectsResponsible ProjectFilm[]           @relation("FilmProjectFilmer")
  notesAuthored           ProjectNote[]           @relation("NoteAuthor")
  client                  Client?                 @relation(fields: [clientId], references: [id])
  preferences             UserPreferences?

  @@index([clientId])
}

model UserPreferences {
  id                           String   @id @default(cuid())
  userId                       String   @unique
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt
  filmProjectsAgentFilter      Json?
  filmProjectsPStatusFilter    Json?
  filmProjectsScopeFilter      Json?
  filmProjectsStatusFilter     Json?
  projectsAgentFilter          Json?
  projectsCmsFilter            Json?
  projectsPriorityFilter       Json?
  projectsStatusFilter         Json?
  printDesignAgentFilter       Json?
  printDesignStatusFilter      Json?
  printDesignProjectTypeFilter Json?
  user                         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Client {
  id                  String               @id @default(cuid())
  name                String
  phone               String?
  notes               String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  customerNo          String?              @unique
  serverId            String?
  finished            Boolean              @default(false)
  workStopped         Boolean              @default(false)
  agencyId            String?
  email               String?
  firstname           String?
  lastname            String?
  salutation          String?
  uploadLinks         Json?
  ftpPasswords        Json?
  // Kundenportal-Felder
  portalEnabled       Boolean              @default(false)
  portalPasswordHash  String?
  portalLastLogin     DateTime?
  portalInvitedAt     DateTime?
  authorizedPersons   AuthorizedPerson[]
  agency              Agency?              @relation(fields: [agencyId], references: [id])
  server              Server?              @relation("ClientToServer", fields: [serverId], references: [id])
  clientServers       ClientServer[]
  contract            ClientContract?
  customerNotices     CustomerNoticeRecipient[]
  emailLogs           EmailLog[]
  favoritedBy         FavoriteClient[]
  joomlaInstallations JoomlaInstallation[]
  projects            Project[]
  users               User[]

  @@index([name])
  @@index([agencyId])
  @@index([serverId])
}

model Agency {
  id              String           @id @default(cuid())
  name            String
  contactName     String?
  contactEmail    String?
  contactPhone    String?
  street          String?
  postalCode      String?
  city            String?
  country         String?
  website         String?
  notes           String?
  logoPath        String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  logoIconPath    String?
  clients         Client[]
  emailSignatures EmailSignature[]
  mailServers     MailServer[]
  customerNotices CustomerNotice[]
}

model Project {
  id                  String               @id @default(cuid())
  title               String?
  type                ProjectType          @default(WEBSITE)
  status              ProjectStatus        @default(WEBTERMIN)
  important           String?
  clientId            String
  agentId             String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  emailLogs           EmailLog[]
  emailQueue          EmailQueue[]
  joomlaInstallations JoomlaInstallation[]
  agent               User?                @relation("AgentProjects", fields: [agentId], references: [id])
  client              Client               @relation(fields: [clientId], references: [id])
  film                ProjectFilm?
  notes               ProjectNote[]
  website             ProjectWebsite?
  printDesign         ProjectPrintDesign?

  @@index([clientId, status])
  @@index([agentId])
}

model ProjectWebsite {
  projectId      String                 @id
  domain         String?
  priority       WebsitePriority        @default(NONE)
  pStatus        ProductionStatus       @default(NONE)
  cms            CMS                    @default(JOOMLA)
  cmsOther       String?
  webDate        DateTime?
  demoDate       DateTime?
  onlineDate     DateTime?
  lastMaterialAt DateTime?
  effortBuildMin Int?
  effortDemoMin  Int?
  seo            SEOStatus?
  textit         TextitStatus?
  accessible     Boolean?
  note           String?
  demoLink       String?
  materialStatus MaterialStatus         @default(ANGEFORDERT)
  isWTAssignment Boolean                @default(false)
  webterminType  WebterminType?
  isRelaunch     Boolean                @default(false)
  domainHistory  ProjectDomainHistory[]
  project        Project                @relation(fields: [projectId], references: [id])
}

model ProjectDomainHistory {
  id         String         @id @default(cuid())
  projectId  String
  domain     String
  assignedAt DateTime       @default(now())
  removedAt  DateTime?
  reason     String?
  createdAt  DateTime       @default(now())
  project    ProjectWebsite @relation(fields: [projectId], references: [projectId])

  @@index([projectId])
  @@index([domain])
}

model ProjectFilm {
  projectId        String               @id
  scope            FilmScope?
  priority         FilmPriority         @default(NONE)
  filmerId         String?
  cutterId         String?
  contractStart    DateTime?
  scouting         DateTime?
  scriptToClient   DateTime?
  scriptApproved   DateTime?
  shootDate        DateTime?
  firstCutToClient DateTime?
  finalToClient    DateTime?
  onlineDate       DateTime?
  lastContact      DateTime?
  status           FilmProjectStatus    @default(AKTIV)
  reminderAt       DateTime?
  note             String?
  finalLink        String?
  onlineLink       String?
  previewVersions  FilmPreviewVersion[]
  cutter           User?                @relation("FilmProjectCutter", fields: [cutterId], references: [id])
  filmer           User?                @relation("FilmProjectFilmer", fields: [filmerId], references: [id])
  project          Project              @relation(fields: [projectId], references: [id])

  @@index([status])
  @@index([filmerId])
  @@index([cutterId])
  @@index([reminderAt])
}

model FilmPreviewVersion {
  id        String      @id @default(cuid())
  projectId String
  version   Int
  sentDate  DateTime
  createdAt DateTime    @default(now())
  link      String      @default("")
  project   ProjectFilm @relation(fields: [projectId], references: [projectId], onDelete: Cascade)

  @@unique([projectId, version])
  @@index([projectId, sentDate])
}

model ProjectPrintDesign {
  projectId              String                @id
  projectType            PrintDesignType?
  pStatus                ProductionStatus      @default(NONE)
  webtermin              DateTime?
  implementation         DateTime?
  designToClient         DateTime?
  designApproval         DateTime?
  finalVersionToClient   DateTime?
  printRequired          Boolean               @default(false)
  printOrderPlaced       DateTime?
  printProvider          String?
  note                   String?
  project                Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ProjectNote {
  id        String   @id @default(cuid())
  projectId String
  authorId  String
  text      String
  createdAt DateTime @default(now())
  author    User     @relation("NoteAuthor", fields: [authorId], references: [id])
  project   Project  @relation(fields: [projectId], references: [id])

  @@index([projectId, createdAt])
}

model Server {
  id                  String               @id @default(cuid())
  name                String
  ip                  String
  froxlorUrl          String?
  mysqlUrl            String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  froxlorApiKey       String?
  froxlorApiSecret    String?
  hostname            String?
  sshHost             String?
  sshPassword         String?
  sshPort             Int?                 @default(22)
  sshUsername         String?
  froxlorVersion      String?              @default("2.0+")
  clients             Client[]             @relation("ClientToServer")
  clientServers       ClientServer[]
  databaseServers     DatabaseServer[]
  joomlaInstallations JoomlaInstallation[]
}

model DatabaseServer {
  id                  String               @id @default(cuid())
  serverId            String
  name                String
  version             String
  host                String               @default("localhost")
  port                Int?                 @default(3306)
  isDefault           Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  froxlorDbServerId   Int?
  server              Server               @relation(fields: [serverId], references: [id], onDelete: Cascade)
  joomlaInstallations JoomlaInstallation[]

  @@index([serverId])
}

model MailServer {
  id         String       @id @default(cuid())
  name       String
  host       String
  port       Int          @default(587)
  username   String?
  password   String?
  fromEmail  String
  fromName   String?
  useTls     Boolean      @default(true)
  notes      String?
  agencyId   String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  emailLogs  EmailLog[]
  emailQueue EmailQueue[]
  agency     Agency?      @relation(fields: [agencyId], references: [id])

  @@index([agencyId])
  @@index([name])
}

model EmailTemplate {
  id        String                @id @default(cuid())
  title     String                @unique
  subject   String
  body      String
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  category  EmailTemplateCategory @default(GENERAL)
  triggers  EmailTrigger[]

  @@index([createdAt])
  @@index([category])
}

model EmailSignature {
  key       String   @id
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  agencyId  String?
  agency    Agency?  @relation(fields: [agencyId], references: [id])
}

model EmailTrigger {
  id              String           @id @default(cuid())
  name            String
  description     String?
  active          Boolean          @default(true)
  triggerType     EmailTriggerType
  projectType     ProjectType?
  conditions      Json
  delayDays       Int?
  delayType       DelayType?
  templateId      String
  recipientConfig Json
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  sentLogs        EmailLog[]
  queuedEmails    EmailQueue[]
  template        EmailTemplate    @relation(fields: [templateId], references: [id])

  @@index([active, triggerType])
  @@index([templateId])
}

model EmailQueue {
  id           String       @id @default(cuid())
  triggerId    String
  projectId    String
  scheduledFor DateTime
  status       QueueStatus  @default(PENDING)
  toEmail      String
  ccEmails     String?
  subject      String
  body         String
  mailServerId String?
  attempts     Int          @default(0)
  lastAttempt  DateTime?
  sentAt       DateTime?
  error        String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  mailServer   MailServer?  @relation(fields: [mailServerId], references: [id])
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  trigger      EmailTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)

  @@index([status, scheduledFor])
  @@index([projectId])
  @@index([triggerId])
}

model EmailLog {
  id           String        @id @default(cuid())
  triggerId    String?
  projectId    String?
  toEmail      String
  ccEmails     String?
  subject      String
  body         String
  sentAt       DateTime      @default(now())
  success      Boolean       @default(true)
  error        String?
  mailServerId String?
  clientId     String?
  client       Client?       @relation(fields: [clientId], references: [id])
  mailServer   MailServer?   @relation(fields: [mailServerId], references: [id])
  project      Project?      @relation(fields: [projectId], references: [id])
  trigger      EmailTrigger? @relation(fields: [triggerId], references: [id])

  @@index([sentAt])
  @@index([projectId])
  @@index([triggerId])
  @@index([clientId])
}

model Notice {
  id                     String                  @id @default(cuid())
  title                  String
  message                String
  visibility             NoticeVisibility        @default(GLOBAL)
  requireAcknowledgement Boolean                 @default(false)
  isActive               Boolean                 @default(true)
  createdById            String
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  createdBy              User                    @relation("NoticesCreated", fields: [createdById], references: [id], onDelete: Cascade)
  acknowledgements       NoticeAcknowledgement[]
  recipients             NoticeRecipient[]

  @@index([isActive, visibility])
  @@index([createdById])
}

model NoticeRecipient {
  noticeId   String
  userId     String
  assignedAt DateTime @default(now())
  notice     Notice   @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([noticeId, userId])
  @@index([userId])
}

model NoticeAcknowledgement {
  id       String   @id @default(cuid())
  noticeId String
  userId   String
  readAt   DateTime @default(now())
  notice   Notice   @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([noticeId, userId])
  @@index([userId])
}

// Kundenportal-Hinweise (separate von Agenten-Hinweisen)
model CustomerNotice {
  id              String                     @id @default(cuid())
  title           String
  message         String
  targetGroup     CustomerNoticeTargetGroup  @default(ALL_CUSTOMERS)
  agencyId        String?                    // Falls AGENCY_CUSTOMERS: welche Agentur
  showOnDashboard Boolean                    @default(false) // Wichtige Hinweise auch auf Dashboard anzeigen
  isActive        Boolean                    @default(true)
  createdById     String
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime                   @updatedAt
  createdBy       User                       @relation("CustomerNoticesCreated", fields: [createdById], references: [id], onDelete: Cascade)
  agency          Agency?                    @relation(fields: [agencyId], references: [id], onDelete: SetNull)
  recipients      CustomerNoticeRecipient[]

  @@index([isActive, targetGroup])
  @@index([isActive, showOnDashboard])
  @@index([createdById])
  @@index([agencyId])
}

// Für SELECTED_CUSTOMERS: welche Kunden sind Empfänger
model CustomerNoticeRecipient {
  noticeId   String
  clientId   String
  assignedAt DateTime       @default(now())
  notice     CustomerNotice @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  client     Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@id([noticeId, clientId])
  @@index([clientId])
}

enum CustomerNoticeTargetGroup {
  ALL_CUSTOMERS       // Alle Kunden
  AGENCY_CUSTOMERS    // Kunden einer bestimmten Agentur (EM oder VW)
  SELECTED_CUSTOMERS  // Ausgewählte Kunden
}

model Feedback {
  id             String         @id @default(cuid())
  title          String
  message        String
  type           FeedbackType   @default(SUGGESTION)
  status         FeedbackStatus @default(OPEN)
  authorId       String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  viewedByAuthor Boolean        @default(false)
  adminResponse  String?
  author         User           @relation("FeedbackAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([status, createdAt])
  @@index([authorId])
  @@index([authorId, viewedByAuthor])
}

model JoomlaInstallation {
  id                         String          @id @default(cuid())
  clientId                   String
  serverId                   String
  customerNo                 String
  folderName                 String
  installPath                String
  installUrl                 String
  databaseName               String
  databasePassword           String
  standardDomain             String
  filesExtracted             Int?
  bytesProcessed             BigInt?
  createdAt                  DateTime        @default(now())
  updatedAt                  DateTime        @updatedAt
  projectId                  String?
  projectAssignmentDismissed Boolean         @default(false)
  databaseServerId           String?
  databaseHost               String?
  databasePort               Int?
  client                     Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  databaseServer             DatabaseServer? @relation(fields: [databaseServerId], references: [id])
  project                    Project?        @relation(fields: [projectId], references: [id])
  server                     Server          @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([serverId])
  @@index([projectId])
  @@index([customerNo])
  @@index([createdAt])
  @@index([projectAssignmentDismissed])
  @@index([databaseServerId])
}

model FavoriteClient {
  id        String   @id @default(cuid())
  userId    String
  clientId  String
  createdAt DateTime @default(now())
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, clientId])
  @@index([userId])
  @@index([clientId])
}

model AuthorizedPerson {
  id         String   @id @default(cuid())
  clientId   String
  salutation String?
  firstname  String
  lastname   String
  email      String
  position   String?
  phone      String?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model ClientServer {
  id         String   @id @default(cuid())
  clientId   String
  serverId   String
  customerNo String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  server     Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@unique([clientId, serverId])
  @@index([clientId])
  @@index([serverId])
  @@index([customerNo])
}

model ClientContract {
  id                  String              @id @default(cuid())
  clientId            String              @unique
  // Vertragsdaten
  contractStart       DateTime?           // Vertragsbeginn
  contractDuration    Int?                // Laufzeit in Monaten
  setupFee            Decimal?            @db.Decimal(10, 2) // Setup in Euro
  paymentInterval     PaymentInterval?    // Zahlweise
  paymentMethod       PaymentMethod?      // Zahlart (SEPA, Rechnung, Sonstige)
  monthlyAmount       Decimal?            @db.Decimal(10, 2) // monatlicher Betrag
  // Leistungsumfang (als Array von Enums)
  services            ContractService[]
  // Adressdaten
  street              String?
  houseNumber         String?
  postalCode          String?
  city                String?
  // Kontaktdaten
  phone1              String?
  phone2              String?
  mobile              String?
  // Weitere Felder
  note                String?             // Notiz
  minTermEnd          DateTime?           // Ende Mindestlaufzeit
  cancellation        String?             // Storno/Kündigung (Freitext)
  sepaMandate         String?             // SEPA-Mandat
  createdBy           String?             // Schreiber (User-ID oder Name)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  // Relation
  client              Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([contractStart])
  @@index([minTermEnd])
}

enum EmailTemplateCategory {
  GENERAL
  WEBSITE
  FILM
  SOCIAL_MEDIA
  PRINT_DESIGN
}

enum Role {
  ADMIN
  AGENT
  CUSTOMER
  SALES
}

enum ProjectType {
  WEBSITE
  FILM
  SOCIAL
  PRINT_DESIGN
}

enum ProjectStatus {
  WEBTERMIN
  MATERIAL
  UMSETZUNG
  DEMO
  ONLINE
  BEENDET
}

enum WebsitePriority {
  NONE
  PRIO_1
  PRIO_2
  PRIO_3
}

enum FilmScope {
  FILM
  DROHNE
  NACHDREH
  FILM_UND_DROHNE
  FOTO
  GRAD_360
  K_A
}

enum FilmPriority {
  NONE
  FILM_SOLO
  PRIO_1
  PRIO_2
}

enum FilmProjectStatus {
  AKTIV
  BEENDET
  WARTEN
  VERZICHT
  MMW
}

enum CMS {
  SHOPWARE
  WORDPRESS
  JOOMLA
  CUSTOM
  OTHER
}

enum ProductionStatus {
  NONE
  BEENDET
  MMW
  VOLLST_A_K
  VOLLST_K_E_S
}

enum SEOStatus {
  NEIN
  NEIN_NEIN
  JA_NEIN
  JA_JA
  JA
}

enum TextitStatus {
  NEIN
  NEIN_NEIN
  JA_NEIN
  JA_JA
  JA
}

enum MaterialStatus {
  ANGEFORDERT
  TEILWEISE
  VOLLSTAENDIG
  NV
}

enum WebterminType {
  TELEFONISCH
  BEIM_KUNDEN
  IN_DER_AGENTUR
  OHNE_TERMIN
}

enum PrintDesignType {
  LOGO
  VISITENKARTE
  FLYER
  PLAKAT
  BROSCHÜRE
  SONSTIGES
}

enum AgentCategory {
  WEBSEITE
  FILM
  SOCIALMEDIA
  PRINT_DESIGN
}

enum EmailTriggerType {
  DATE_FIELD_SET
  DATE_REACHED
  CONDITION_MET
  MANUAL
}

enum DelayType {
  BEFORE
  AFTER
  EXACT
}

enum QueueStatus {
  PENDING
  SENDING
  SENT
  FAILED
  CANCELLED
  PENDING_CONFIRMATION
}

enum NoticeVisibility {
  GLOBAL
  TARGETED
}

enum FeedbackType {
  BUG
  SUGGESTION
  IMPROVEMENT
  OTHER
}

enum FeedbackStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  DISMISSED
}

enum PaymentInterval {
  MONTHLY       // monatlich
  QUARTERLY     // vierteljährlich
  SEMI_ANNUAL   // halbjährlich
  ANNUAL        // jährlich
}

enum PaymentMethod {
  SEPA          // SEPA-Lastschrift
  INVOICE       // Rechnung
  OTHER         // Sonstige
}

enum ContractService {
  WEBSITE_SUCCESS     // Webseite (Success)
  WEBSITE_HOSTING     // Webseitenhosting
  TEXTERSTELLUNG      // Texterstellung (Textit)
  FILM_IMAGE          // Film (Image)
  FILM_HOSTING        // Filmhosting
  SEO_PLUS            // SEOplus
  BARRIEREFREIHEIT    // Barrierefreiheit (B-free)
  DROHNE_ONAIR        // Drohne (onAir)
  FOTOERSTELLUNG      // Fotoerstellung
  ONLINESHOP_SHOPIT   // Onlineshop (Shopit)
  FULL_CONTENT        // Full Content
  SECURE_PLUS         // SecurePlus
  ADWORDS_ADLEIT      // Adwords (Adleit)
  SOCIAL_MEDIA        // Social-Media
}
